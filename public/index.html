<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sommalier Gent - Wine Agent</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="background-container">
        <img src="winery-background.png" alt="Winery Background" class="background-image">
    </div>
    
    <div class="modal-container" id="agentModal">
        <div class="modal-content">
            <!-- Agentforce Embedded Messaging Agent -->
            <div id="embedded-messaging-agent"></div>
        </div>
    </div>

    <!-- Agentforce Bootstrap Script -->
    <script type='text/javascript'>
    // Set up observer to catch sidebar creation
    var sidebarObserver = null;
    var modalAgent = document.getElementById('embedded-messaging-agent');
    
    function moveSidebarToModal(sidebar) {
        if (!sidebar || !modalAgent) return false;
        
        // Check if already moved
        if (sidebar.parentElement === modalAgent) {
            return true;
        }
        
        try {
            // Force remove from current location
            if (sidebar.parentNode) {
                sidebar.parentNode.removeChild(sidebar);
            }
            
            // Add to modal
            modalAgent.appendChild(sidebar);
            
            // Force styles
            sidebar.style.position = 'absolute';
            sidebar.style.top = '0';
            sidebar.style.left = '0';
            sidebar.style.right = '0';
            sidebar.style.bottom = '0';
            sidebar.style.width = '100%';
            sidebar.style.height = '100%';
            sidebar.style.display = 'block';
            sidebar.style.visibility = 'visible';
            sidebar.style.opacity = '1';
            sidebar.style.zIndex = '1001';
            sidebar.classList.add('embedded-in-modal');
            
            return true;
        } catch (err) {
            console.error('Error moving sidebar:', err);
            return false;
        }
    }
    
    function initEmbeddedMessaging() {
        try {
            embeddedservice_bootstrap.settings.language = 'en_US';

            embeddedservice_bootstrap.init(
                '00DHu00000izUN6',
                'SommalierGent_1',
                'https://storm-11c5bf736713cf.my.site.com/ESWSommalierGent1762152842517',
                {
                    scrt2URL: 'https://storm-11c5bf736713cf.my.salesforce-scrt.com'
                }
            );

            // Use MutationObserver to catch sidebar when it's created
            sidebarObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            // Check if this is the sidebar or contains it
                            var sidebar = null;
                            if (node.classList && node.classList.contains('embeddedServiceSidebar')) {
                                sidebar = node;
                            } else {
                                sidebar = node.querySelector && node.querySelector('.embeddedServiceSidebar');
                            }
                            
                            if (sidebar) {
                                moveSidebarToModal(sidebar);
                            }
                        }
                    });
                });
            });
            
            // Start observing the body for changes
            sidebarObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Also check periodically as backup
            var checkInterval = setInterval(function() {
                var sidebar = document.querySelector('.embeddedServiceSidebar:not(.embedded-in-modal)');
                var button = document.querySelector('.embeddedServiceHelpButton');
                
                if (sidebar) {
                    if (moveSidebarToModal(sidebar)) {
                        // Auto-open after moving
                        setTimeout(function() {
                            // Hide button
                            if (button) {
                                button.style.display = 'none';
                            }
                            
                            // Try to open chat
                            if (window.embeddedservice_bootstrap && window.embeddedservice_bootstrap.openEmbeddedMessaging) {
                                window.embeddedservice_bootstrap.openEmbeddedMessaging();
                            }
                            
                            // Ensure sidebar is visible
                            sidebar.style.display = 'block';
                            sidebar.style.visibility = 'visible';
                            sidebar.style.opacity = '1';
                        }, 300);
                    }
                }
                
                // Hide button if found
                if (button) {
                    button.style.display = 'none';
                }
            }, 200);
            
            // Stop checking after 15 seconds
            setTimeout(function() {
                clearInterval(checkInterval);
            }, 15000);
        } catch (err) {
            console.error('Error loading Embedded Messaging: ', err);
        }
    }
    </script>
    <script type='text/javascript' src='https://storm-11c5bf736713cf.my.site.com/ESWSommalierGent1762152842517/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
</body>
</html>
